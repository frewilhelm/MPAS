# Concept Paper: Projects

Table of contents:
- [Context](#context)
- [Proposal](#proposal)
- [Product Controller](#product-controller)
- [Product Configuration](#product-configuration-values)
- [Appendix A: APIs](#appendix-a-apis)
- [Appendix B: Glossary](#appendix-b-glossary)

## Context

User story: https://github.com/open-component-model/MPAS/issues/4

Products are made available to the MPAS system as OCM Components via a Subscription. Multiple instances of a Product may be installed that refer to same Subscription.

A Product Deployment API Object describes the intended Product Deployment that should be realized by the MPAS Control Plane.

The Product Deployment manifest should be generated by the MPAS Control Plane and committed to the Project Git Repository when a new Project-Subscription-Binding is created. Project Subscription Bindings enable us to install multiple instances of a Product which refer to the same Subscription in a Project.

Users can provide necessary configuration for a Product Deployment and instructions on doing so will be generated by the `Project`  controller.

The MPAS control-plane (Project controller) is responsible for validating the Product Deployment and configuration values before it is merged to the main branch for the Project. At this point the `ProductDeployment` is reconciled by Flux.

## Proposal

We will introduce a Custom Resource named `ProductDeployment` that will extend the Kubernetes API to provide an API object responsible installing products. The `ProductDeployment` object will be consumed by a Custom Controller, (`Product` controller), in order to execute the functionality required to install the product.

The `ProductDeployment` manifest will be committed to a Git repository by the `Project` controller and reconciled to the Kubernetes cluster using Flux. Note: The `ProductDeployment` manifest is constructed by the `Project` controller and is realized by the `Product` controller.

Alongside the `ProductDeployment` manifest there may be a `values.yaml` file that contains site-specific configuration values, supplied by the customer.

The functions required to be carried out by the `Product` controller are:
- create a ComponentVersion custom resource using the `spec.componentVersion` field
- for each pipeline specified in `spec.pipelines` create an Localization, Configuration & Flux OCI Repository CRs
- for each target specified in `spec.targetRefs` fetch the target and create a Flux Kustomization for each pipeline. The Kustomization should be configured with the target KubeConfig
- detect drift in any of the managed resources
- resolve drift in any of the managed resources

### Product Controller

To implement the functionality required for MPAS Products we will create a dedicated Kubernetes controller. The controller will act as a coordinator, it's primary function being to translate the `Product` Custom Resource into lower level resources which will perform the specific operations.

The reconciliation process for the product controller will be as follows:
- fetch `spec.component.registryRef` object and create the `ComponentVersion` CR
- for each pipeline in the `spec.pipelines` array:
  - 1. create the Localization CR
  - 2. fetch the configuration values provided by the user and create the Configuration CR
  - 3. create a Flux OCIRepository pointing at the snapshot created in step 2
  - 4. for each target in the `spec.targetRefs`:
      - 4.1 fetch the target
      - 4.2 create a kustomization configured with the target's KubeConfig which reconciles the OCIRepository from step 3

### Product Configuration Values

As previously mentioned, the product directory may contain a `values.yaml` that contains customer supplied parameters. The `Product` controller must fetch this file from Git and pass the values to the Configuration Custom Resource. This can be done by fetching the artifact from the Project's Flux GitRepository and setting the values on the `Configuration` custom resource's `spec.values` field, which allows for inline values to be passed.

## Appendix A: APIs

### A.1. Product Deployment Kubernetes API Object

The API for a `Product` will be as follows:

```yaml
apiVersion: mpas.ocm.software/v1alpha1
kind: ProductDeployment
metadata:
  name: string # the name of the product deployment
  namespace: string # the storage namespace of the product deployment
  labels:
    # project and subscription labels can be used
    # to group deployments belong to a particular project or subscription
    mpas.ocm.software/project: string #
    mpas.ocm.software/subscription: string
spec:
  # the component field is used to create a ComponentVersion custom resource
  component:
    name: string
    version: string
    # the registry field is a reference to an OCIRegistry object
    registryRef:
      name: string
      namespace: string
  # pipelines will be translated into
  # sets of
  pipelines:
  - name: string
    # will be used to create Localization Custom Resource
    localization:
      resource: # the ocm resource to be Localized
        name: string
        version: string
      rules: # the ocm resource containing the Localization rules
        name: string
        version: string
    # the configuration field will create a Configuration Custom Resource
    # it will also fetch the valuesFile
    # and pass them to the configuration
    # a Flux OCI Repository will also be created
    configuration:
      rules:
        name: string
        version: string
      valuesFile:
        path: string
  # for each of the pipelines we will create
  # a kustomization that reconciles the configured snapshot
  # for each pipeline (MVP will only support kubernetes targets)
  targetRefs:
  - name: string
    namespace: string
```

## Appendix B: Glossary

#### Product

An MPAS Product is software that has been packaged using the Open Component Model. It contains both configuration resources, technical artifacts (such as Kubernetes manifests, docker images), localization & configuration rules and instructions that can be used by the MPAS to create a generate a product deployment pipeline.

#### Product Deployment

The `ProductDeployment` is a Kubernetes API object that specifies the information necessary to generate a product deployment pipeline. `ProductDeployment`'s are consumed by the Product controller.

#### Project

An MPAS Project is a collection of Products. Products are installed using OCM and GitOps. Products can be stored in one or more Git repositories that are managed by the Project.

The `Project` Kubernetes API object that contains the metadata required to create and manage an individual MPAS Project.

#### Subscription

A Subscription is request for an OCM component to be replicated from an delivery registry to a customer registry.

The `Subscription` Kubernetes API object specifies the details of the component, version constraints and the delivery & customer registries.

#### Project Subscription Binding

A Project Subscription Binding creates a relation between a Project and a component Subscription.

The `ProjectSubscriptionBinding` object contains a references to `Project` and `Subscription` objects. The Project controller watches `ProjectSubscriptionBinding` objects and creates `ProductDeployment` manifests.

#### Target

A Target is a deployment environment for the final result of an MPAS product generation pipeline.

The `Target` Kubernetes API object specifies the access details for the target. Creating or managing the target infrastructure is not the responsibility of the MPAS system.

#### Project Target Binding

A Project Target Binding creates a relation between a Project and a component Subscription.

The `ProjectTargetBinding` object contains a references to `Project` and `Target` objects. The Project controller will look for available `ProjectTargetBinding`'s whenever it is creating a `ProductDeployment`.

#### Repository

A Repository is a Git repository that is created to house products installed as part of an MPAS project.

Because the Flux Source controller already defines an object named `GitRepository`, for the MPAS we shall define a Kubernetes API object named `Repository` that is describes project git repositories.
